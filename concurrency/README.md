# Spring-Concurrency
- 스프링에서 발생하는 동시성 이슈에 대해서 다룬다.
- 이를 Redis를 통해 분산락을 구현하여 해결해본다.

## 요구사항
- 책과 재고는 일대일 관계로 매핑되어 있음 (하나의 도서당 1의 재고)
- 이를 바탕으로 도출할 수 있는 Core 비즈니스 로직 다음과 같다.
  - 도서 구매시 성공하면 재고가 1 감소해야함
  - 도서 구매 시 재고가 부족하면 예외를 반환해야함.
  - 재고 등록 시 성송하면 재고가 1 증가

## 분산 락(Distributed Lock) 주의사항
- Redisson을 사용하 분산락을 구현할때 유의할 점은 분산락 해제 시점과 트랜잭션 커밋시점을 일치해주어야 한다는 것입니다.
  - 스프링에서 제공하는 @Transactional은 호출되는 메서드 외부에서 프록시를 통해 처리되지만, 락 획득과 해제가 트랜잭션 내부에서 일어난다면 시점 불일치로 인해 무결성이 깨질 수 있다.
    - 만약 스레드 1과 스레드 2가 경합한다면 스레드 1의 락이 해제되고 트랜잭션 커밋이 되는 사이에 스레드 2가 락을 획득하게 되는 상황이 발생할 수 있다.
    - 데이터베이스 상으로 락이 존재하지 않기 때문에 스레드 2는 데이터를 읽어오게 되고, 스레드 1의 변경 내용은 최종적으로 유실될 수 있다. 
- 그렇기에 최종적으로 트랜잭션이 락 범위내에 포함되도록 로직을 구성하여야함 